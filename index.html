<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Audio Pro Max | 頂級私人音樂工作站</title>
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        let synthesizer;
        let isGenerating = false;

        // 初始化 WebGPU 引擎
        async function init() {
            const statusText = document.getElementById('status-text');
            const progress = document.getElementById('load-progress');
            
            try {
                statusText.innerText = "正在喚醒 WebGPU 核心模型 (約 1.2GB)...";
                progress.style.width = "30%";
                
                synthesizer = await pipeline('text-to-audio', 'Xenova/musicgen-medium', {
                    device: 'webgpu',
                    dtype: 'fp32'
                });
                
                progress.style.width = "100%";
                statusText.innerText = "✅ 系統就緒 | 無浮水印模式已啟動";
                statusText.style.color = "#00ffcc";
                document.getElementById('genBtn').disabled = false;
            } catch (e) {
                statusText.innerText = "錯誤：瀏覽器不支援 WebGPU 或顯存不足";
                statusText.style.color = "#ff4444";
            }
        }

        async function generate() {
            if (isGenerating) return;
            isGenerating = true;
            
            const genBtn = document.getElementById('genBtn');
            const statusText = document.getElementById('status-text');
            genBtn.innerText = "運算中 (Neural Processing)...";
            genBtn.style.opacity = "0.6";

            // 獲取設定值
            const prompt = document.getElementById('prompt').value;
            const style = document.getElementById('style').value;
            const duration = parseInt(document.getElementById('duration').value);
            const guidance = parseFloat(document.getElementById('guidance').value);
            const temp = parseFloat(document.getElementById('temp').value);
            
            const fullPrompt = `${style}, ${prompt}, high fidelity, masterpiece, studio grade`;
            const maxTokens = duration * 50; 

            try {
                const output = await synthesizer(fullPrompt, {
                    max_new_tokens: maxTokens,
                    do_sample: true,
                    guidance_scale: guidance,
                    temperature: temp
                });

                let audioData = output.audio;

                // --- 擬人化去特徵處理 (Bypass AI Detection) ---
                // 注入類比底噪與非線性擾動
                for (let i = 0; i < audioData.length; i++) {
                    // 加入極微小的隨機漂移，破壞 AI 的完美頻譜
                    audioData[i] += (Math.random() - 0.5) * 0.0008; 
                }

                const wavBlob = makeWav(audioData, output.sampling_rate);
                const url = window.URL.createObjectURL(wavBlob);
                
                const player = document.getElementById('player');
                player.src = url;
                player.style.display = "block";
                
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.style.display = "block";
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Studio_Pro_${Date.now()}.wav`;
                    a.click();
                };

                statusText.innerText = "✨ 生成成功 | 已通過擬人化濾鏡";
            } catch (err) {
                statusText.innerText = "運算超時或顯存溢出，請縮短長度";
            } finally {
                isGenerating = false;
                genBtn.innerText = "開始專業生成";
                genBtn.style.opacity = "1";
            }
        }

        // WAV 封裝
        function makeWav(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            const writeString = (off, s) => { for (let i=0; i<s.length; i++) view.setUint8(off+i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + samples.length * 2, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, samples.length * 2, true);
            for (let i=0; i<samples.length; i++) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(44 + i*2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return new Blob([view], {type: 'audio/wav'});
        }

        window.init = init;
        window.generate = generate;
    </script>
    <style>
        :root { --neon: #00ffcc; --bg: #08080a; --card: #121216; }
        body { background: var(--bg); color: #fff; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* 側邊控制欄 */
        .sidebar { width: 380px; background: var(--card); border-right: 1px solid #222; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .main-view { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(circle at center, #1a1a2e 0%, #08080a 100%); position: relative; }
        
        h1 { font-size: 24px; font-weight: 900; color: var(--neon); margin-bottom: 5px; text-transform: uppercase; }
        .version { font-size: 10px; color: #555; margin-bottom: 30px; letter-spacing: 2px; }

        .control-group { margin-bottom: 20px; }
        label { font-size: 11px; color: #777; font-weight: bold; display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        textarea, select, input { width: 100%; background: #1c1c22; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; box-sizing: border-box; outline: none; transition: 0.3s; }
        textarea:focus, select:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(0,255,204,0.2); }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        button { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 800; font-size: 15px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        #genBtn { background: var(--neon); color: #000; box-shadow: 0 4px 20px rgba(0,255,204,0.3); }
        #genBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0,255,204,0.5); }
        #genBtn:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }
        
        #downloadBtn { background: transparent; border: 1.5px solid var(--neon); color: var(--neon); display: none; }
        #downloadBtn:hover { background: var(--neon); color: #000; }

        /* 狀態顯示 */
        #status-area { margin-top: auto; padding-top: 20px; }
        #status-text { font-size: 12px; color: #888; margin-bottom: 8px; }
        .progress-bar { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; }
        #load-progress { width: 0%; height: 100%; background: var(--neon); transition: 0.5s; }

        /* 音樂播放器樣式 */
        audio { margin-top: 30px; width: 400px; height: 40px; filter: invert(1) hue-rotate(180deg); display: none; }
        .visualizer { width: 300px; height: 100px; border-bottom: 2px solid var(--neon); display: flex; align-items: flex-end; gap: 3px; margin-bottom: 20px; }
        .bar { flex: 1; background: var(--neon); height: 10%; opacity: 0.3; }
    </style>
</head>
<body onload="init()">

    <div class="sidebar">
        <h1>PRO AUDIO STUDIO</h1>
        <div class="version">BUILD 2026.02 | NO-TRACE MODE</div>

        <div class="control-group">
            <label>音樂風格預設 (Presets)</label>
            <select id="style">
                <option value="Lo-fi hip hop, vinyl crackle, cozy, chill">放鬆 Lo-fi (黑膠質感)</option>
                <option value="80s Synthwave, retro future, neon lights, analog">復古電子 (賽博質感)</option>
                <option value="Cinematic orchestral, epic, strings, Hans Zimmer style">史詩交響 (好萊塢風格)</option>
                <option value="Modern K-Pop, high energy, crisp production">現代流行 (K-Pop 節奏)</option>
                <option value="Jazz lounge, smooth saxophone, coffee shop">爵士酒廊 (薩克斯風)</option>
                <option value="Techno dark club, heavy bass, industrial">工業硬核 (Techno)</option>
            </select>
        </div>

        <div class="control-group">
            <label>客製化描述 (Prompt)</label>
            <textarea id="prompt" placeholder="輸入旋律細節，例如：憂鬱的鋼琴、清脆的雨聲..."></textarea>
        </div>

        <div class="row">
            <div class="control-group">
                <label>長度 (秒)</label>
                <input type="number" id="duration" value="10" min="2" max="20">
            </div>
            <div class="control-group">
                <label>提示詞權重</label>
                <input type="number" id="guidance" value="3.5" step="0.5">
            </div>
        </div>

        <div class="control-group">
            <label>生成溫度 (隨機性 0.1 - 1.5)</label>
            <input type="range" id="temp" min="0.1" max="1.5" step="0.1" value="1.1">
        </div>

        <button id="genBtn" disabled onclick="generate()">開始專業生成</button>
        <button id="downloadBtn">下載無浮水印 WAV</button>

        <div id="status-area">
            <div id="status-text">初始化系統中...</div>
            <div class="progress-bar"><div id="load-progress"></div></div>
        </div>
    </div>

    <div class="main-view">
        <div class="visualizer">
            <div class="bar" style="height: 40%"></div><div class="bar" style="height: 70%"></div><div class="bar" style="height: 50%"></div>
            <div class="bar" style="height: 90%"></div><div class="bar" style="height: 30%"></div><div class="bar" style="height: 60%"></div>
        </div>
        <div style="text-align: center;">
            <p style="font-size: 14px; color: #555; max-width: 400px;">
                本工作站採用本地 WebGPU 指令集進行 PCM 運算，生成的音訊不包含任何數位指紋數據，且已自動通過擬人化濾鏡混淆。
            </p>
        </div>
        <audio id="player" controls></audio>
    </div>

</body>
</html>
