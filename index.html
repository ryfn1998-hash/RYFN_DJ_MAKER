<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate AI Studio | 頂級私人音樂工作站</title>
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        let synthesizer;
        let isGenerating = false;

        // 初始化系統
        async function init() {
            const statusText = document.getElementById('status-text');
            const loader = document.getElementById('loader');
            try {
                statusText.innerText = "正在激活 WebGPU 核心 (iOS/Win/Mac)...";
                // 使用中型模型以平衡 iPhone 效能與品質
                synthesizer = await pipeline('text-to-audio', 'Xenova/musicgen-medium', {
                    device: 'webgpu',
                });
                statusText.innerText = "✅ 系統已就緒 | 無浮水印模式";
                loader.style.width = "100%";
                document.getElementById('genBtn').disabled = false;
            } catch (e) {
                statusText.innerText = "錯誤：硬體不支援 WebGPU。請更新 iOS 或使用電腦 Chrome。";
                console.error(e);
            }
        }

        async function generate() {
            if (isGenerating) return;
            isGenerating = true;
            
            const genBtn = document.getElementById('genBtn');
            const statusText = document.getElementById('status-text');
            const prompt = document.getElementById('prompt').value;
            const style = document.getElementById('style').value;
            const isInst = document.getElementById('inst-mode').checked;
            const duration = parseInt(document.getElementById('duration').value);
            const guidance = parseFloat(document.getElementById('guidance').value);

            genBtn.innerText = "正在編織音訊數據...";
            genBtn.style.background = "linear-gradient(90deg, #555, #222)";

            // 處理 Prompt 邏輯
            let fullPrompt = `${style}, ${prompt}`;
            if (isInst) fullPrompt += ", pure instrumental, no vocals, high fidelity";
            
            // 2026 算法優化：50 tokens/sec
            const maxTokens = duration * 50;

            try {
                const output = await synthesizer(fullPrompt, {
                    max_new_tokens: maxTokens,
                    do_sample: true,
                    guidance_scale: guidance,
                    temperature: 1.15
                });

                let audioData = output.audio;

                // --- 擬人化混淆 (Bypass Detection) ---
                for (let i = 0; i < audioData.length; i++) {
                    audioData[i] += (Math.random() - 0.5) * 0.0007; // 注入類比底噪
                }

                const wavBlob = makeWav(audioData, output.sampling_rate);
                const url = window.URL.createObjectURL(wavBlob);
                
                const player = document.getElementById('player');
                player.src = url;
                player.style.display = "block";
                
                const dlBtn = document.getElementById('dlBtn');
                dlBtn.style.display = "block";
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Private_Music_Pro_${Date.now()}.wav`;
                    a.click();
                };

                statusText.innerText = "✨ 生成成功 | 已通過擬人化濾鏡";
            } catch (err) {
                statusText.innerText = "設備顯存不足，請嘗試縮短長度。";
                console.error(err);
            } finally {
                isGenerating = false;
                genBtn.innerText = "開始生成專業音訊";
                genBtn.style.background = "linear-gradient(135deg, #00f2fe 0%, #4facfe 100%)";
            }
        }

        function makeWav(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            const writeString = (off, s) => { for (let i=0; i<s.length; i++) view.setUint8(off+i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + samples.length * 2, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, samples.length * 2, true);
            for (let i=0; i<samples.length; i++) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(44 + i*2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return new Blob([view], {type: 'audio/wav'});
        }

        window.init = init;
        window.generate = generate;
    </script>
    <style>
        :root {
            --primary: #4facfe;
            --secondary: #00f2fe;
            --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.05);
        }
        body {
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .app-container {
            width: 95%; max-width: 500px; margin: 20px auto;
            background: var(--glass); backdrop-filter: blur(20px);
            border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
            padding: 30px; box-sizing: border-box; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        h1 {
            text-align: center; font-size: 28px; font-weight: 800; margin-bottom: 5px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .tagline { text-align: center; font-size: 10px; color: #64748b; margin-bottom: 30px; letter-spacing: 2px; }

        .group { margin-bottom: 20px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; }
        
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; color: #fff; padding: 15px; font-size: 16px; box-sizing: border-box; outline: none;
        }
        
        .toggle-box { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; }
        
        .slider-val { display: flex; justify-content: space-between; font-size: 14px; color: var(--primary); margin-top: 5px; }
        
        button {
            width: 100%; padding: 20px; border-radius: 15px; border: none; font-weight: 800; font-size: 18px;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin-top: 10px;
        }
        #genBtn { background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); color: #fff; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); }
        #genBtn:active { transform: scale(0.98); }
        #genBtn:disabled { background: #334155; opacity: 0.5; }

        #dlBtn { background: transparent; border: 2px solid var(--primary); color: var(--primary); display: none; margin-top: 15px; }

        #status-area { margin-top: 25px; text-align: center; }
        #status-text { font-size: 12px; color: #94a3b8; margin-bottom: 10px; }
        .bar-container { height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        #loader { width: 0%; height: 100%; background: var(--primary); transition: 0.4s; }

        audio { width: 100%; margin-top: 25px; display: none; filter: hue-rotate(180deg) invert(1); }
    </style>
</head>
<body onload="init()">

<div class="app-container">
    <h1>AUDIO STUDIO</h1>
    <div class="tagline">ZERO-TRACE PRIVATE ENGINE 2026</div>

    <div class="group">
        <label>音樂預設風格</label>
        <select id="style">
            <option value="Lo-fi hip hop, jazzy, chill, vinyl crackle">放鬆 Lo-fi (黑膠)</option>
            <option value="Epic cinematic, Hans Zimmer style, dramatic">史詩電影 (交響)</option>
            <option value="80s Japanese City Pop, nostalgic, upbeat">城市流行 (City Pop)</option>
            <option value="Techno warehouse rave, dark, industrial">重工業電子 (Techno)</option>
            <option value="Mandopop ballad, emotional piano, high quality">華語流行抒情 (鋼琴)</option>
        </select>
    </div>

    <div class="group">
        <label>自定義客製化描述</label>
        <textarea id="prompt" placeholder="例如：夏日海灘的微風、輕快的木吉他..."></textarea>
    </div>

    <div class="group">
        <div class="toggle-box">
            <span style="font-size: 14px; font-weight: bold;">純音樂模式 (Instrumental)</span>
            <input type="checkbox" id="inst-mode" checked style="width: auto;">
        </div>
    </div>

    <div class="group">
        <label>生成長度 (2-240秒)</label>
        <input type="range" id="duration" min="5" max="240" value="30" oninput="dVal.innerText = this.value + ' 秒'">
        <div class="slider-val"><span id="dVal">30 秒</span><span>Max 4分</span></div>
    </div>

    <div class="group" style="display: none;"> <input type="hidden" id="guidance" value="3.5">
    </div>

    <button id="genBtn" disabled onclick="generate()">開始生成專業音訊</button>
    
    <div id="status-area">
        <div id="status-text">系統初始化中...</div>
        <div class="bar-container"><div id="loader"></div></div>
    </div>

    <audio id="player" controls></audio>
    <button id="dlBtn">下載無標記 WAV 檔</button>
</div>

<p style="font-size: 10px; color: #475569; margin-top: 10px;">
    本引擎採用 WebGPU 本地運算，音效已自動執行擬人化濾鏡。
</p>

</body>
</html>
