<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate AI Studio | 頂級相容旗艦版</title>
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        let synthesizer;
        let isGenerating = false;

        // 自動適應引擎初始化
        async function init() {
            const statusText = document.getElementById('status-text');
            const loader = document.getElementById('loader');
            
            try {
                statusText.innerText = "正在偵測硬體加速器...";
                
                // 嘗試使用 WebGPU，若失敗則降級至 WASM (CPU)
                const device = 'gpu' in navigator ? 'webgpu' : 'wasm';
                statusText.innerText = `正在啟用 ${device.toUpperCase()} 引擎 (無浮水印模式)...`;

                synthesizer = await pipeline('text-to-audio', 'Xenova/musicgen-small', {
                    device: device,
                });
                
                statusText.innerText = `✅ 系統就緒 | 模式：${device === 'webgpu' ? '硬體加速' : '全面相容'}`;
                statusText.style.color = "#00ffcc";
                loader.style.width = "100%";
                document.getElementById('genBtn').disabled = false;
            } catch (e) {
                statusText.innerText = "啟動失敗，請檢查網路連線或更新瀏覽器。";
                console.error(e);
            }
        }

        async function generate() {
            if (isGenerating) return;
            isGenerating = true;
            
            const genBtn = document.getElementById('genBtn');
            const statusText = document.getElementById('status-text');
            const prompt = document.getElementById('prompt').value;
            const style = document.getElementById('style').value;
            const isInst = document.getElementById('inst-mode').checked;
            const duration = parseInt(document.getElementById('duration').value);

            statusText.innerText = "音訊合成中，請稍候...";
            genBtn.innerText = "運算中...";
            genBtn.style.opacity = "0.5";

            let fullPrompt = `${style}, ${prompt}`;
            if (isInst) fullPrompt += ", instrumental, no vocals, professional studio recording";
            
            const maxTokens = duration * 50;

            try {
                const output = await synthesizer(fullPrompt, {
                    max_new_tokens: maxTokens,
                    do_sample: true,
                    temperature: 1.1
                });

                let audioData = output.audio;

                // 擬人化濾鏡：注入隨機底噪防止 AI 識別
                for (let i = 0; i < audioData.length; i++) {
                    audioData[i] += (Math.random() - 0.5) * 0.0006;
                }

                const wavBlob = makeWav(audioData, output.sampling_rate);
                const url = window.URL.createObjectURL(wavBlob);
                
                document.getElementById('player').src = url;
                document.getElementById('player').style.display = "block";
                
                const dlBtn = document.getElementById('dlBtn');
                dlBtn.style.display = "block";
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Studio_Pro_${Date.now()}.wav`;
                    a.click();
                };

                statusText.innerText = "✨ 生成完畢 | 已通過擬人化濾鏡";
            } catch (err) {
                statusText.innerText = "運算資源不足，請縮短秒數。";
                console.error(err);
            } finally {
                isGenerating = false;
                genBtn.innerText = "開始生成專業音訊";
                genBtn.style.opacity = "1";
            }
        }

        function makeWav(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            const writeString = (off, s) => { for (let i=0; i<s.length; i++) view.setUint8(off+i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + samples.length * 2, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, samples.length * 2, true);
            for (let i=0; i<samples.length; i++) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(44 + i*2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return new Blob([view], {type: 'audio/wav'});
        }

        window.init = init;
        window.generate = generate;
    </script>
    <style>
        :root { --p: #00f2fe; --s: #4facfe; --bg: #0f172a; }
        body { margin: 0; padding: 0; background: var(--bg); color: #f8fafc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { width: 95%; max-width: 480px; margin: 20px; background: rgba(255,255,255,0.05); backdrop-filter: blur(15px); border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); padding: 25px; box-sizing: border-box; }
        h1 { text-align: center; background: linear-gradient(to right, var(--p), var(--s)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .sub { text-align: center; font-size: 10px; color: #475569; margin-bottom: 20px; }
        label { display: block; font-size: 12px; color: #94a3b8; margin: 15px 0 5px; font-weight: bold; }
        input, select, textarea { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 12px; color: #fff; padding: 12px; box-sizing: border-box; outline: none; }
        .toggle { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; margin-top: 15px; }
        button { width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; margin-top: 15px; }
        #genBtn { background: linear-gradient(135deg, var(--p), var(--s)); color: #000; box-shadow: 0 10px 20px rgba(0,242,254,0.2); }
        #dlBtn { background: transparent; border: 1px solid var(--p); color: var(--p); display: none; }
        #status-area { margin-top: 20px; text-align: center; font-size: 12px; color: #64748b; }
        .bar-bg { height: 4px; background: #1e293b; border-radius: 10px; margin-top: 8px; overflow: hidden; }
        #loader { width: 0%; height: 100%; background: var(--p); transition: 0.3s; }
        audio { width: 100%; margin-top: 20px; display: none; filter: invert(1) hue-rotate(180deg); }
    </style>
</head>
<body onload="init()">
    <div class="card">
        <h1>AUDIO STUDIO</h1>
        <div class="sub">ULTIMATE COMPATIBLE EDITION 2026</div>

        <label>音樂風格</label>
        <select id="style">
            <option value="80s City Pop, nostalgic, upbeat">城市流行 (City Pop)</option>
            <option value="Lo-fi hip hop, chill, study, piano">放鬆 Lo-fi (鋼琴)</option>
            <option value="Epic cinematic, dramatic, strings">史詩交響 (電影感)</option>
            <option value="Cyberpunk techno, dark, industrial">賽博電子 (Techno)</option>
            <option value="Acoustic folk, guitar, warm, soft">民謠吉他 (溫暖)</option>
        </select>

        <label>客製化描述</label>
        <textarea id="prompt" placeholder="例如：清晨的森林、輕快的鼓點..."></textarea>

        <div class="toggle">
            <span style="font-size: 14px;">純音樂模式 (Instrumental)</span>
            <input type="checkbox" id="inst-mode" checked style="width: 20px; height: 20px;">
        </div>

        <label>生成長度 (5-240秒)</label>
        <input type="range" id="duration" min="5" max="240" value="30" oninput="dText.innerText = this.value + ' 秒'">
        <div style="display:flex; justify-content: space-between; font-size: 12px; color: var(--p); margin-top: 5px;">
            <span id="dText">30 秒</span><span>Max 4分</span>
        </div>

        <button id="genBtn" disabled onclick="generate()">開始生成專業音訊</button>
        <audio id="player" controls></audio>
        <button id="dlBtn">下載無浮水印 WAV</button>

        <div id="status-area">
            <div id="status-text">初始化相容引擎中...</div>
            <div class="bar-bg"><div id="loader"></div></div>
        </div>
    </div>
</body>
</html>
