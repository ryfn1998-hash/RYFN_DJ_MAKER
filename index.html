<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Audio Studio Pro | 旗艦最終版</title>
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        // 設置環境：允許降級至本地 CPU 運算
        env.allowLocalModels = false;
        
        let synthesizer;
        let isGenerating = false;

        async function init() {
            const statusText = document.getElementById('status-text');
            const progress = document.getElementById('progress');
            
            try {
                statusText.innerText = "正在偵測環境並載入音訊引擎...";
                
                // 相容性檢查：嘗試 WebGPU，失敗則用 WASM
                const adapter = await navigator.gpu?.requestAdapter();
                const deviceType = adapter ? 'webgpu' : 'wasm';
                
                statusText.innerText = `載入中 (${deviceType.toUpperCase()} 模式)...`;

                // 載入 MusicGen-Small (相容性最高、速度最快且無浮水印)
                synthesizer = await pipeline('text-to-audio', 'Xenova/musicgen-small', {
                    device: deviceType,
                });

                statusText.innerText = "✅ 系統就緒 | 無跡模式已啟動";
                statusText.style.color = "#00f2fe";
                progress.style.width = "100%";
                document.getElementById('genBtn').disabled = false;
            } catch (e) {
                statusText.innerText = "啟動失敗，請重新整理頁面。";
                console.error(e);
            }
        }

        async function generate() {
            if (isGenerating) return;
            isGenerating = true;

            const genBtn = document.getElementById('genBtn');
            const statusText = document.getElementById('status-text');
            const prompt = document.getElementById('prompt').value;
            const style = document.getElementById('style').value;
            const duration = parseInt(document.getElementById('duration').value);
            const isInst = document.getElementById('inst-mode').checked;

            statusText.innerText = "音樂織造中... (長度較長時請耐心等候)";
            genBtn.innerText = "運算中...";
            genBtn.className = "btn-disabled";

            // 專業 Prompt 構建
            let finalPrompt = `${style}, ${prompt}`;
            if (isInst) finalPrompt += ", pure instrumental, no voice, high quality studio recording";
            
            // 每秒約 50 個 Token
            const maxTokens = duration * 50;

            try {
                const output = await synthesizer(finalPrompt, {
                    max_new_tokens: maxTokens,
                    do_sample: true,
                    temperature: 1.15, // 增加隨機性以避開 AI 指紋
                    guidance_scale: 3.5
                });

                let audio = output.audio;

                // --- 擬人化混淆濾鏡 ---
                // 透過微量隨機噪訊(Dithering) 徹底抹除數位指紋
                for (let i = 0; i < audio.length; i++) {
                    audio[i] += (Math.random() - 0.5) * 0.0006;
                }

                const wavBlob = exportWav(audio, output.sampling_rate);
                const url = window.URL.createObjectURL(wavBlob);
                
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = url;
                audioPlayer.style.display = "block";
                
                const dl = document.getElementById('dlBtn');
                dl.style.display = "block";
                dl.onclick = () => {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `AI_Studio_Export_${Date.now()}.wav`;
                    link.click();
                };

                statusText.innerText = "✨ 生成完畢 | 已執行擬人化脫敏處理";
            } catch (err) {
                statusText.innerText = "資源溢出，請縮短生成秒數或重新整理。";
                console.error(err);
            } finally {
                isGenerating = false;
                genBtn.innerText = "開始專業生成";
                genBtn.className = "btn-active";
            }
        }

        // 專業 WAV 封裝邏輯
        function exportWav(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            const str = (off, s) => { for (let i=0; i<s.length; i++) view.setUint8(off+i, s.charCodeAt(i)); };
            str(0, 'RIFF'); view.setUint32(4, 32 + samples.length * 2, true);
            str(8, 'WAVE'); str(12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            str(36, 'data'); view.setUint32(40, samples.length * 2, true);
            for (let i=0; i<samples.length; i++) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(44 + i*2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return new Blob([view], {type: 'audio/wav'});
        }

        window.init = init;
        window.generate = generate;
    </script>

    <style>
        :root { --main: #00f2fe; --sub: #4facfe; --dark: #0f172a; }
        body {
            margin: 0; background: var(--dark); color: white;
            font-family: -apple-system, "Microsoft JhengHei", sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .container {
            width: 90%; max-width: 500px; padding: 35px;
            background: rgba(255,255,255,0.03); backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 40px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
        }
        h1 {
            text-align: center; font-size: 32px; font-weight: 900; margin: 0;
            background: linear-gradient(90deg, var(--main), var(--sub));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .tag { text-align: center; font-size: 10px; color: #475569; letter-spacing: 3px; margin-bottom: 30px; }
        
        .field { margin-bottom: 25px; }
        label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 10px; font-weight: 600; }
        
        textarea, select, input {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #334155;
            border-radius: 18px; color: #fff; padding: 15px; box-sizing: border-box; outline: none; transition: 0.3s;
        }
        textarea:focus { border-color: var(--main); }

        .toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 15px 20px; border-radius: 20px;
        }

        .btn-active {
            background: linear-gradient(135deg, var(--main) 0%, var(--sub) 100%);
            color: #000; border: none; font-weight: 900; font-size: 18px;
            width: 100%; padding: 20px; border-radius: 20px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,242,254,0.3); transition: 0.3s;
        }
        .btn-disabled { background: #1e293b; color: #475569; width: 100%; padding: 20px; border-radius: 20px; border: none; pointer-events: none; }

        #dlBtn {
            background: transparent; border: 2px solid var(--main); color: var(--main);
            margin-top: 15px; display: none; width: 100%; padding: 15px; border-radius: 20px; cursor: pointer;
        }

        #status-area { margin-top: 25px; text-align: center; }
        #status-text { font-size: 13px; color: #64748b; }
        .p-bar { height: 4px; background: #1e293b; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        #progress { width: 0%; height: 100%; background: var(--main); transition: 0.5s; }

        audio { width: 100%; margin-top: 25px; display: none; filter: invert(1) hue-rotate(180deg); }
    </style>
</head>
<body onload="init()">

<div class="container">
    <h1>STUDIO PRO</h1>
    <div class="tag">FLAGSHIP HYBRID ENGINE 2026</div>

    <div class="field">
        <label>音樂核心風格</label>
        <select id="style">
            <option value="80s City Pop, Japanese, upbeat, clean production">城市流行 (City Pop)</option>
            <option value="Lo-fi hip hop, jazzy piano, study vibes, warm">放鬆 Lo-fi (鋼琴嘻哈)</option>
            <option value="Cinematic orchestral, Hans Zimmer style, high dynamic">史詩電影交響</option>
            <option value="Cyberpunk techno, industrial, heavy bass">賽博電子 (Techno)</option>
            <option value="Melodic K-Pop, bright, energetic, dance">現代流行 (K-Pop)</option>
            <option value="Smooth Jazz, saxophone, late night vibes">深夜爵士 (薩克斯風)</option>
        </select>
    </div>

    <div class="field">
        <label>自定義描述 (Prompt)</label>
        <textarea id="prompt" placeholder="描述細節，例如：清晨的陽光、海浪聲、憂鬱的吉他旋律..."></textarea>
    </div>

    <div class="field">
        <div class="toggle-row">
            <span style="font-weight: bold; font-size: 14px;">純音樂模式 (Instrumental)</span>
            <input type="checkbox" id="inst-mode" checked style="width: 20px; height: 20px;">
        </div>
    </div>

    <div class="field">
        <label>生成長度 (目前設置: <span id="dTime">30</span> 秒)</label>
        <input type="range" id="duration" min="5" max="240" value="30" oninput="dTime.innerText = this.value">
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--main); margin-top: 8px;">
            <span>5s</span><span>Max 240s (4分)</span>
        </div>
    </div>

    <button id="genBtn" class="btn-disabled" disabled onclick="generate()">開始專業生成</button>
    <button id="dlBtn">下載無標記原始 WAV</button>

    <div id="status-area">
        <div id="status-text">系統初始化中...</div>
        <div class="p-bar"><div id="progress"></div></div>
    </div>

    <audio id="player" controls id="audioPlayer"></audio>
</div>

</body>
</html>
