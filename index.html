<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WebGPU 私人無浮水印音樂工廠 2026</title>
    <script type="module">
        // 導入 2026 年最新的 Transformers.js，支援 WebGPU 直接運算
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        let synthesizer;

        // 1. 初始化模型 (直接下載到瀏覽器快取)
        async function init() {
            document.getElementById('status').innerText = "正在初始化 WebGPU 引擎...";
            synthesizer = await pipeline('text-to-audio', 'Xenova/musicgen-small', {
                device: 'webgpu', // 強制使用顯卡，速度極快且無雲端追蹤
            });
            document.getElementById('status').innerText = "✅ 引擎就緒 (無浮水印模式)";
            document.getElementById('genBtn').disabled = false;
        }

        // 2. 生成與擬人化處理
        async function generate() {
            const prompt = document.getElementById('prompt').value;
            document.getElementById('status').innerText = "正在進行本地張量運算 (Raw PCM)...";
            
            // 生成原始音訊
            const output = await synthesizer(prompt, {
                max_new_tokens: 256, // 約 5-10 秒，可調大
                do_sample: true,
                temperature: 1.3,    // 提高隨機性，減少 AI 味
            });

            // 3. 擬人化：手動注入微小隨機噪音 (Bypass 偵測器)
            const audioData = output.audio;
            for (let i = 0; i < audioData.length; i++) {
                audioData[i] += (Math.random() - 0.5) * 0.001; // 注入 -60dB 底噪
            }

            // 導出為 WAV
            const blob = window.URL.createObjectURL(makeWav(audioData, output.sampling_rate));
            document.getElementById('player').src = blob;
            document.getElementById('status').innerText = "✨ 生成完畢！已通過擬人化混淆。";
        }

        // 簡易 WAV 封裝函式 (確保格式純淨)
        function makeWav(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            const writeString = (off, s) => { for (let i=0; i<s.length; i++) view.setUint8(off+i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + samples.length * 2, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, samples.length * 2, true);
            for (let i=0; i<samples.length; i++) view.setInt16(44 + i*2, samples[i] * 32767, true);
            return new Blob([view], {type: 'audio/wav'});
        }

        window.init = init;
        window.generate = generate;
    </script>
    <style>
        body { background: #050505; color: #00ffcc; font-family: sans-serif; display: flex; justify-content: center; padding: 50px; }
        .box { background: #111; padding: 30px; border-radius: 20px; border: 1px solid #00ffcc; width: 400px; box-shadow: 0 0 20px #00ffcc44; }
        textarea { width: 100%; background: #222; border: none; color: white; padding: 10px; border-radius: 10px; margin: 10px 0; }
        button { width: 100%; padding: 15px; background: #00ffcc; color: black; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #333; color: #666; }
        #status { font-size: 12px; margin: 10px 0; color: #888; text-align: center; }
    </style>
</head>
<body onload="init()">
    <div class="box">
        <h3>Private Music Gen (Offline)</h3>
        <p style="font-size: 11px;">⚠️ 首次開啟需下載約 500MB 模型數據</p>
        <textarea id="prompt" placeholder="例如：Lo-fi hip hop, smooth saxophone, raining background..."></textarea>
        <button id="genBtn" disabled onclick="generate()">開始無浮水印生成</button>
        <div id="status">正在加載 WebGPU 核心...</div>
        <audio id="player" controls style="width: 100%; margin-top: 20px;"></audio>
    </div>
</body>
</html>
